/*
 * MD2Parser.h
 *
 *  Created on: 2012.12.27
 *      Author: MS
 */

#ifndef MD2PARSER_H_
#define MD2PARSER_H_

#include "Multiplatform/Ghost.h"
#include "Multiplatform/ServiceLocator.h"
#include "Multiplatform/FileManager.h"

#define MD2_ID 844121161
#define MD2_VERSION 8

struct MD2Header {
	int id;
	int version;
	int skinWidth;
	int skinHeight;
	int frameSize;
	int numSkins;
	int numVerts;
	int numTexCoord;
	int numTriangles;
	int numGLCommands;
	int numFrames;
	int offsetSkins;
	int offsetTexCoord;
	int offsetTriangles;
	int offsetFrames;
	int offsetGLCommands;
	int offsetEnd;
};

struct MD2Skin {
	char name[64]; // Name of the texture.
};

struct MD2Vertex {
	UINT8 v[3];
	UINT8 normalIndex;
};

struct MD2UV {
	short u;
	short v;
};

struct MD2Triangle {
	UINT16 vertex[3]; // Indices.
	UINT16 uv[3];
};

struct MD2Frame {
	~MD2Frame() {
		delete [] vertices;
	}
	float scale[3];
	float translate[3];
	char name[16];
	MD2Vertex* vertices;
};


struct MD2Object {
	~MD2Object() {
		delete [] skins_;
		delete [] uv_;
		delete [] triangles_;
		delete [] commands_;
		delete [] frames_;
	}

	MD2Header header_;
	MD2Skin* skins_;
	MD2UV* uv_;
	MD2Triangle* triangles_;
	int* commands_;
	MD2Frame* frames_;

};

class MD2Parser {
public:
	static bool parse(
		MD2Object& obj,
		const string& file,
		ServiceLocator* services);
};

const float g_md2Normals[][3] = {
	{ -0.525731f,  0.000000f,  0.850651f }, 
	{ -0.442863f,  0.238856f,  0.864188f }, 
	{ -0.295242f,  0.000000f,  0.955423f }, 
	{ -0.309017f,  0.500000f,  0.809017f }, 
	{ -0.162460f,  0.262866f,  0.951056f }, 
	{  0.000000f,  0.000000f,  1.000000f }, 
	{  0.000000f,  0.850651f,  0.525731f }, 
	{ -0.147621f,  0.716567f,  0.681718f }, 
	{  0.147621f,  0.716567f,  0.681718f }, 
	{  0.000000f,  0.525731f,  0.850651f }, 
	{  0.309017f,  0.500000f,  0.809017f }, 
	{  0.525731f,  0.000000f,  0.850651f }, 
	{  0.295242f,  0.000000f,  0.955423f }, 
	{  0.442863f,  0.238856f,  0.864188f }, 
	{  0.162460f,  0.262866f,  0.951056f }, 
	{ -0.681718f,  0.147621f,  0.716567f }, 
	{ -0.809017f,  0.309017f,  0.500000f }, 
	{ -0.587785f,  0.425325f,  0.688191f }, 
	{ -0.850651f,  0.525731f,  0.000000f }, 
	{ -0.864188f,  0.442863f,  0.238856f }, 
	{ -0.716567f,  0.681718f,  0.147621f }, 
	{ -0.688191f,  0.587785f,  0.425325f }, 
	{ -0.500000f,  0.809017f,  0.309017f }, 
	{ -0.238856f,  0.864188f,  0.442863f }, 
	{ -0.425325f,  0.688191f,  0.587785f }, 
	{ -0.716567f,  0.681718f, -0.147621f }, 
	{ -0.500000f,  0.809017f, -0.309017f }, 
	{ -0.525731f,  0.850651f,  0.000000f }, 
	{  0.000000f,  0.850651f, -0.525731f }, 
	{ -0.238856f,  0.864188f, -0.442863f }, 
	{  0.000000f,  0.955423f, -0.295242f }, 
	{ -0.262866f,  0.951056f, -0.162460f }, 
	{  0.000000f,  1.000000f,  0.000000f }, 
	{  0.000000f,  0.955423f,  0.295242f }, 
	{ -0.262866f,  0.951056f,  0.162460f }, 
	{  0.238856f,  0.864188f,  0.442863f }, 
	{  0.262866f,  0.951056f,  0.162460f }, 
	{  0.500000f,  0.809017f,  0.309017f }, 
	{  0.238856f,  0.864188f, -0.442863f }, 
	{  0.262866f,  0.951056f, -0.162460f }, 
	{  0.500000f,  0.809017f, -0.309017f }, 
	{  0.850651f,  0.525731f,  0.000000f }, 
	{  0.716567f,  0.681718f,  0.147621f }, 
	{  0.716567f,  0.681718f, -0.147621f }, 
	{  0.525731f,  0.850651f,  0.000000f }, 
	{  0.425325f,  0.688191f,  0.587785f }, 
	{  0.864188f,  0.442863f,  0.238856f }, 
	{  0.688191f,  0.587785f,  0.425325f }, 
	{  0.809017f,  0.309017f,  0.500000f }, 
	{  0.681718f,  0.147621f,  0.716567f }, 
	{  0.587785f,  0.425325f,  0.688191f }, 
	{  0.955423f,  0.295242f,  0.000000f }, 
	{  1.000000f,  0.000000f,  0.000000f }, 
	{  0.951056f,  0.162460f,  0.262866f }, 
	{  0.850651f, -0.525731f,  0.000000f }, 
	{  0.955423f, -0.295242f,  0.000000f }, 
	{  0.864188f, -0.442863f,  0.238856f }, 
	{  0.951056f, -0.162460f,  0.262866f }, 
	{  0.809017f, -0.309017f,  0.500000f }, 
	{  0.681718f, -0.147621f,  0.716567f }, 
	{  0.850651f,  0.000000f,  0.525731f }, 
	{  0.864188f,  0.442863f, -0.238856f }, 
	{  0.809017f,  0.309017f, -0.500000f }, 
	{  0.951056f,  0.162460f, -0.262866f }, 
	{  0.525731f,  0.000000f, -0.850651f }, 
	{  0.681718f,  0.147621f, -0.716567f }, 
	{  0.681718f, -0.147621f, -0.716567f }, 
	{  0.850651f,  0.000000f, -0.525731f }, 
	{  0.809017f, -0.309017f, -0.500000f }, 
	{  0.864188f, -0.442863f, -0.238856f }, 
	{  0.951056f, -0.162460f, -0.262866f }, 
	{  0.147621f,  0.716567f, -0.681718f }, 
	{  0.309017f,  0.500000f, -0.809017f }, 
	{  0.425325f,  0.688191f, -0.587785f }, 
	{  0.442863f,  0.238856f, -0.864188f }, 
	{  0.587785f,  0.425325f, -0.688191f }, 
	{  0.688191f,  0.587785f, -0.425325f }, 
	{ -0.147621f,  0.716567f, -0.681718f }, 
	{ -0.309017f,  0.500000f, -0.809017f }, 
	{  0.000000f,  0.525731f, -0.850651f }, 
	{ -0.525731f,  0.000000f, -0.850651f }, 
	{ -0.442863f,  0.238856f, -0.864188f }, 
	{ -0.295242f,  0.000000f, -0.955423f }, 
	{ -0.162460f,  0.262866f, -0.951056f }, 
	{  0.000000f,  0.000000f, -1.000000f }, 
	{  0.295242f,  0.000000f, -0.955423f }, 
	{  0.162460f,  0.262866f, -0.951056f }, 
	{ -0.442863f, -0.238856f, -0.864188f }, 
	{ -0.309017f, -0.500000f, -0.809017f }, 
	{ -0.162460f, -0.262866f, -0.951056f }, 
	{  0.000000f, -0.850651f, -0.525731f }, 
	{ -0.147621f, -0.716567f, -0.681718f }, 
	{  0.147621f, -0.716567f, -0.681718f }, 
	{  0.000000f, -0.525731f, -0.850651f }, 
	{  0.309017f, -0.500000f, -0.809017f }, 
	{  0.442863f, -0.238856f, -0.864188f }, 
	{  0.162460f, -0.262866f, -0.951056f }, 
	{  0.238856f, -0.864188f, -0.442863f }, 
	{  0.500000f, -0.809017f, -0.309017f }, 
	{  0.425325f, -0.688191f, -0.587785f }, 
	{  0.716567f, -0.681718f, -0.147621f }, 
	{  0.688191f, -0.587785f, -0.425325f }, 
	{  0.587785f, -0.425325f, -0.688191f }, 
	{  0.000000f, -0.955423f, -0.295242f }, 
	{  0.000000f, -1.000000f,  0.000000f }, 
	{  0.262866f, -0.951056f, -0.162460f }, 
	{  0.000000f, -0.850651f,  0.525731f }, 
	{  0.000000f, -0.955423f,  0.295242f }, 
	{  0.238856f, -0.864188f,  0.442863f }, 
	{  0.262866f, -0.951056f,  0.162460f }, 
	{  0.500000f, -0.809017f,  0.309017f }, 
	{  0.716567f, -0.681718f,  0.147621f }, 
	{  0.525731f, -0.850651f,  0.000000f }, 
	{ -0.238856f, -0.864188f, -0.442863f }, 
	{ -0.500000f, -0.809017f, -0.309017f }, 
	{ -0.262866f, -0.951056f, -0.162460f }, 
	{ -0.850651f, -0.525731f,  0.000000f }, 
	{ -0.716567f, -0.681718f, -0.147621f }, 
	{ -0.716567f, -0.681718f,  0.147621f }, 
	{ -0.525731f, -0.850651f,  0.000000f }, 
	{ -0.500000f, -0.809017f,  0.309017f }, 
	{ -0.238856f, -0.864188f,  0.442863f }, 
	{ -0.262866f, -0.951056f,  0.162460f }, 
	{ -0.864188f, -0.442863f,  0.238856f }, 
	{ -0.809017f, -0.309017f,  0.500000f }, 
	{ -0.688191f, -0.587785f,  0.425325f }, 
	{ -0.681718f, -0.147621f,  0.716567f }, 
	{ -0.442863f, -0.238856f,  0.864188f }, 
	{ -0.587785f, -0.425325f,  0.688191f }, 
	{ -0.309017f, -0.500000f,  0.809017f }, 
	{ -0.147621f, -0.716567f,  0.681718f }, 
	{ -0.425325f, -0.688191f,  0.587785f }, 
	{ -0.162460f, -0.262866f,  0.951056f }, 
	{  0.442863f, -0.238856f,  0.864188f }, 
	{  0.162460f, -0.262866f,  0.951056f }, 
	{  0.309017f, -0.500000f,  0.809017f }, 
	{  0.147621f, -0.716567f,  0.681718f }, 
	{  0.000000f, -0.525731f,  0.850651f }, 
	{  0.425325f, -0.688191f,  0.587785f }, 
	{  0.587785f, -0.425325f,  0.688191f }, 
	{  0.688191f, -0.587785f,  0.425325f }, 
	{ -0.955423f,  0.295242f,  0.000000f }, 
	{ -0.951056f,  0.162460f,  0.262866f }, 
	{ -1.000000f,  0.000000f,  0.000000f }, 
	{ -0.850651f,  0.000000f,  0.525731f }, 
	{ -0.955423f, -0.295242f,  0.000000f }, 
	{ -0.951056f, -0.162460f,  0.262866f }, 
	{ -0.864188f,  0.442863f, -0.238856f }, 
	{ -0.951056f,  0.162460f, -0.262866f }, 
	{ -0.809017f,  0.309017f, -0.500000f }, 
	{ -0.864188f, -0.442863f, -0.238856f }, 
	{ -0.951056f, -0.162460f, -0.262866f }, 
	{ -0.809017f, -0.309017f, -0.500000f }, 
	{ -0.681718f,  0.147621f, -0.716567f }, 
	{ -0.681718f, -0.147621f, -0.716567f }, 
	{ -0.850651f,  0.000000f, -0.525731f }, 
	{ -0.688191f,  0.587785f, -0.425325f }, 
	{ -0.587785f,  0.425325f, -0.688191f }, 
	{ -0.425325f,  0.688191f, -0.587785f }, 
	{ -0.425325f, -0.688191f, -0.587785f }, 
	{ -0.587785f, -0.425325f, -0.688191f }, 
	{ -0.688191f, -0.587785f, -0.425325f }
};

#endif /* MD2PARSER_H_ */
